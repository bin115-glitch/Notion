name: Notion Overdue Mailer

on:
  schedule:
    # Chạy hàng ngày lúc 9:00 AM UTC (4:00 PM VN)
    - cron: '0 9 * * *'
  workflow_dispatch: # Cho phép chạy thủ công

jobs:
  send-overdue-emails:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create config file
      run: |
        # Extract recipients from email_recipients.json
        RECIPIENTS=$(python -c "
        import json
        with open('email_recipients.json', 'r') as f:
            data = json.load(f)
        recipients = data.get('recipients', [])
        print(','.join([f'\"{r}\"' for r in recipients]))
        ")
        
        cat > notion_token.json << EOF
        {
          "notion_tokens": [
            {
              "token": "${{ secrets.NOTION_TOKEN }}",
              "databases": [
                {
                  "id": "${{ secrets.NOTION_DATABASE_ID }}",
                  "recipients": [$RECIPIENTS]
                }
              ]
            }
          ],
          "smtp": {
            "host": "${{ secrets.SMTP_HOST }}",
            "port": ${{ secrets.SMTP_PORT }},
            "user": "${{ secrets.SMTP_USER }}",
            "pass": "${{ secrets.SMTP_PASS }}"
          }
        }
        EOF
        
    - name: Run Notion Overdue Mailer
      run: python main.py
      
    - name: Clean up config
      if: always()
      run: rm -f notion_token.json
